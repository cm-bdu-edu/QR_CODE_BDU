<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Trình tạo mã QR</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="./image/Logo.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        .qr-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }

        @media (min-width: 640px) {
            .qr-item {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .qr-item img {
            max-width: 100px;
            margin: 0 auto 1rem;
        }

        @media (min-width: 640px) {
            .qr-item img {
                margin: 0 1rem 0 0;
            }
        }

        .qr-item .qr-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        @media (min-width: 640px) {
            .qr-item .qr-actions {
                align-items: flex-end;
                width: auto;
            }
        }

        .qr-item button {
            margin-top: 0.5rem;
            background-color: #ff6b6b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            width: 100%;
            max-width: 200px;
        }

        /* Chỉnh sửa giao diện */
        .qr-color-picker {
            display: flex;
            flex-direction: column;
        }

        .qr-color-input {
            width: 100px;
            /* Giới hạn chiều rộng input */
            height: 40px;
            /* Chiều cao hài hòa */
            padding: 5px;
            cursor: pointer;
        }

        #color-display {
            transition: background-color 0.3s ease-in-out;
            /* Hiệu ứng mượt */
        }

        @media (min-width: 640px) {
            .qr-item button {
                width: auto;
            }
        }

        .qr-item button:hover {
            background-color: #ff4c4c;
        }

        /* Responsive header */
        @media (max-width: 640px) {
            #user-info {
                margin-top: 1rem;
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Responsive modal */
        @media (max-width: 768px) {
            #edit-modal>div {
                width: 90%;
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
        }
    </style>
</head>

<body class="bg-white-400 text-gray-800">
    <header class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex flex-wrap items-center justify-between">
            <div class="flex items-center gap-x-3 w-full sm:w-auto justify-center sm:justify-start">
                <img src="./image/appLogoIcon.png" alt="Logo" class="h-10 w-auto mr-3" loading="lazy">
                <h1 class="text-xl sm:text-2xl font-bold whitespace-nowrap">Trình tạo mã QR</h1>
            </div>
            <div id="user-info"
                class="flex items-center gap-x-4 w-full sm:w-auto justify-center sm:justify-end mt-4 sm:mt-0">
                <span id="user-name" class="font-medium"></span>
                <button id="logout-btn"
                    class="bg-red-500 px-4 py-2 rounded-md hover:bg-red-600 focus:outline-none focus:ring focus:ring-red-300 w-full sm:w-auto">
                    Đăng Xuất
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto bg-white rounded-lg shadow-lg p-4 sm:p-6 mt-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Section: QR Code List -->
            <div class="order-2 lg:order-1">
                <h2 class="text-lg font-semibold mb-4">Danh sách mã QR của bạn</h2>
                <input type="text" id="search-qr" placeholder="Tìm kiếm mã QR..."
                    class="w-full p-2 mb-4 border rounded-md" oninput="filterQRCodes()">
                <div id="qr-list-container"
                    class="bg-gray-100 p-4 rounded-md shadow-md max-h-[calc(100vh-400px)] overflow-y-auto">
                    <ul id="qr-list"></ul>
                </div>
            </div>

            <!-- Right Section: QR Code Generator -->
            <div class="order-1 lg:order-2">
                <h2 class="text-lg font-semibold mb-4">Tạo Mã QR</h2>
                <div class="mb-4">
                    <label for="qr-name" class="block font-medium mb-2">Tên gợi nhớ</label>
                    <input type="text" id="qr-name" placeholder="Tên mã QR (VD: QR Sự kiện)"
                        class="w-full p-3 border rounded-md">
                </div>
                <div class="mb-4">
                    <label for="qr-content" class="block font-medium mb-2">Nội dung <i>(đường dẫn liên kết)</i></label>
                    <input type="url" id="qr-content" class="w-full p-3 border rounded-md" pattern="https?://.+"
                        placeholder="https:// hoặc http://" required oninput="validateURL(this)">
                    <small id="url-error" class="text-red-500 hidden">Vui lòng nhập đúng định dạng URL (bắt đầu bằng
                        http:// hoặc https://)</small>
                </div>

                <div class="qr-color-picker mb-4">
                    <label for="qr-color" class="block font-medium mb-2 text-gray-700">Chọn màu mã QR</label>
                    <div class="flex items-center gap-4">
                        <input type="color" id="qr-color" value="#000000"
                            class="qr-color-input p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <!-- <div id="color-display" class="w-16 h-8 border rounded-md" style="background-color: #000000;">
                        </div> -->
                    </div>
                </div>

                <button onclick="generateAndSaveQRCode()"
                    class="w-full sm:w-auto bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                    Tạo và Lưu
                </button>
            </div>
        </div>

        <!-- Modal for Editing QR -->
        <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white p-4 sm:p-6 rounded-md shadow-md w-full max-w-md">
                <h2 class="text-lg font-semibold mb-4">Chỉnh sửa Mã QR</h2>
                <div class="mb-4">
                    <label for="edit-qr-name" class="block font-medium mb-2">Tên gợi nhớ</label>
                    <input type="text" id="edit-qr-name" class="w-full p-3 border rounded-md">
                </div>
                <div class="mb-4">
                    <label for="edit-qr-content" class="block font-medium mb-2">Nội dung <i>(đường dẫn liên
                            kết)</i></label>
                    <input type="url" id="edit-qr-content" class="w-full p-3 border rounded-md" pattern="https?://.+"
                        placeholder="https:// hoặc http://" required oninput="validateURL(this)">
                    <small id="url-error-edit" class="text-red-500 hidden">Vui lòng nhập đúng định dạng URL (bắt đầu
                        bằng http:// hoặc https://)</small>
                </div>
                <div class="flex flex-col sm:flex-row justify-end gap-2">
                    <button onclick="saveQRCodeEdit()"
                        class="w-full sm:w-auto bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                        Lưu
                    </button>
                    <button onclick="closeEditModal()"
                        class="w-full sm:w-auto bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        Hủy
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import {
            getDatabase,
            ref,
            push,
            set,
            onValue,
            query,
            orderByChild,
            equalTo,
            update
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDnkxcPxH3Gw0l-BNro17KKX2AEV_6bsaE",
            authDomain: "qr-code-65808.firebaseapp.com",
            databaseURL: "https://qr-code-65808-default-rtdb.firebaseio.com",
            projectId: "qr-code-65808",
            storageBucket: "qr-code-65808.firebasestorage.app",
            messagingSenderId: "953231243938",
            appId: "1:953231243938:web:318fde18c08154e01df5fb",
            measurementId: "G-FMV89YRW06"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        let currentUser = null;
        let qrCodesListener = null;

        // tạo mã QR
        async function generateQRCode({
            content,
            name = '',
            color = '#000000',
            size = 400,
            logoSize = 60,
            padding = 5,
            dpi = 4,
            includeText = true,
            logoUrl = './image/Logo.ico',
            isListItem = false
        } = {}) {
            try {
                if (!content) {
                    throw new Error('Content is required for QR code generation');
                }

                const adjustedLogoSize = isListItem ? size * 0.15 : logoSize;

                // Tạo QR code với padding nhỏ hơn
                const qrDataUrl = await QRCode.toDataURL(content, {
                    width: size,
                    margin: 1,
                    color: {
                        dark: color,
                        light: '#ffffff'
                    }
                });

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Điều chỉnh kích thước canvas và khoảng cách text
                const textHeight = includeText ? 10 : 0; // Tăng chiều cao phần text
                const textSpacing = 15; // Thêm khoảng cách giữa QR và text
                const canvasSize = size + (padding * 2);

                canvas.width = canvasSize * dpi;
                canvas.height = (canvasSize + textHeight + textSpacing) * dpi;
                ctx.scale(dpi, dpi);

                // Vẽ background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvasSize, canvasSize + textHeight + textSpacing);

                // Vẽ QR code
                const qrImage = await loadImage(qrDataUrl);
                ctx.drawImage(qrImage, padding, padding, size, size);

                // Vẽ logo nếu có
                if (logoUrl) {
                    const logoImage = await loadImage(logoUrl);
                    const logoX = (size - adjustedLogoSize) / 2 + padding;
                    const logoY = (size - adjustedLogoSize) / 2 + padding;
                    ctx.drawImage(logoImage, logoX, logoY, adjustedLogoSize, adjustedLogoSize);
                }

                // Vẽ text với khoảng cách đã điều chỉnh
                if (includeText) {
                    ctx.font = 'bold 20px Arial';
                    ctx.fillStyle = '#d32f2f';
                    ctx.textAlign = 'center';
                    // Điều chỉnh vị trí text, thêm textSpacing để tạo khoảng cách
                    ctx.fillText('BDU-CM', canvasSize / 2, canvasSize + textSpacing);
                }

                return {
                    dataUrl: canvas.toDataURL('image/png', 1.0),
                    canvas: canvas
                };
            } catch (error) {
                console.error('Error generating QR code:', error);
                throw error;
            }
        }

        // tải hình ảnh
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        // tạo và lưu mã QR
        async function createAndSaveQRCode() {
            const name = document.getElementById("qr-name").value.trim();
            const content = document.getElementById("qr-content").value.trim();
            const color = document.getElementById("qr-color").value;

            if (!name || !content || !currentUser) {
                alert("Vui lòng nhập đầy đủ thông tin được yêu cầu hoặc đăng nhập lại!");
                return;
            }

            if (!validateURL(document.getElementById("qr-content"))) {
                return;
            }

            try {
                const qrRef = ref(database, "qrCodes");
                const newQRCodeRef = push(qrRef);
                const redirectURL = `${window.location.origin}/QR_CODE_BDU/redirect.html?id=${newQRCodeRef.key}`;

                await set(newQRCodeRef, {
                    userId: currentUser.uid,
                    name,
                    content,
                    redirectURL,
                    color,
                    createdAt: new Date().toISOString()
                });

                resetForm();
                alert("Mã QR được tạo thành công!");
                await loadQRCodes(currentUser.uid);
            } catch (error) {
                console.error("Error creating QR code:", error);
                alert("Đã xảy ra lỗi khi tạo mã QR!");
            }
        }

        // load danh sách mã QR
        async function loadQRCodes(userId) {
            if (qrCodesListener) {
                qrCodesListener();
            }

            const qrList = document.getElementById("qr-list");
            const qrRef = ref(database, "qrCodes");
            const userQrQuery = query(qrRef, orderByChild("userId"), equalTo(userId));

            qrCodesListener = onValue(userQrQuery, async (snapshot) => {
                qrList.innerHTML = "";
                const data = snapshot.val();

                if (data) {
                    const qrArray = Object.entries(data)
                        .map(([key, value]) => ({ key, ...value }))
                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    for (const qr of qrArray) {
                        await renderQRCodeItem(qr, qrList);
                    }
                } else {
                    qrList.innerHTML = "<p class='text-center text-gray-500'>Chưa có mã QR nào được tạo.</p>";
                }
            });
        }

        // render mã QR
        async function renderQRCodeItem(qr, qrList) {
            const qrItem = document.createElement("li");
            qrItem.className = "qr-item";

            try {
                const qrCode = await generateQRCode({
                    content: qr.redirectURL,
                    color: qr.color,
                    size: 100,
                    includeText: false,
                    isListItem: true // Thêm flag để chỉ định đây là item trong danh sách
                });

                const img = document.createElement("img");
                img.src = qrCode.dataUrl;
                qrItem.appendChild(img);

                const qrActions = createQRCodeActions(qr);
                qrItem.appendChild(qrActions);
                qrList.appendChild(qrItem);
            } catch (error) {
                console.error('Error rendering QR code:', error);
            }
        }

        // tạo hành động cho mã QR
        function createQRCodeActions(qr) {
            const qrActions = document.createElement("div");
            qrActions.className = "qr-actions";

            // Name
            const nameText = document.createElement("p");
            nameText.className = "font-medium text-lg mb-2 text-left";
            nameText.textContent = qr.name;
            qrActions.appendChild(nameText);

            // Date
            const dateText = document.createElement("p");
            dateText.className = "text-sm text-gray-500 mb-2";
            dateText.textContent = `Ngày tạo: ${new Date(qr.createdAt).toLocaleDateString()}`;
            qrActions.appendChild(dateText);

            // Buttons
            const buttonContainer = document.createElement("div");
            buttonContainer.className = "flex space-x-2 mt-2";

            // Download button
            const downloadButton = createButton("Tải xuống", "bg-blue-500", () =>
                downloadQRCode(qr));

            // Edit button
            const editButton = createButton("Chỉnh sửa", "bg-yellow-500", () =>
                showEditModal(qr.key, qr.name, qr.content));

            // Delete button
            const deleteButton = createButton("Xóa", "bg-red-500", () =>
                deleteQRCode(qr.key));

            buttonContainer.append(downloadButton, editButton, deleteButton);
            qrActions.appendChild(buttonContainer);

            return qrActions;
        }

        function createButton(text, className, onClick) {
            const button = document.createElement("button");
            button.className = `${className} hover:${className.replace('500', '600')} text-white px-4 py-2 rounded`;
            button.textContent = text;
            button.onclick = onClick;
            return button;
        }

        // Tải mã QR
        async function downloadQRCode(qr) {
            try {
                const qrCode = await generateQRCode({
                    content: qr.redirectURL,
                    name: qr.name,
                    color: qr.color,
                    margin: 0,
                    isListItem: false // Sử dụng kích thước logo mặc định cho bản tải xuống
                });

                const link = document.createElement('a');
                link.href = qrCode.dataUrl;
                link.download = `${qr.name}.png`;
                link.click();
            } catch (error) {
                console.error("Error downloading QR code:", error);
                alert("Đã xảy ra lỗi khi tải xuống mã QR!");
            }
        }

        // URL Validation
        function validateURL(input) {
            const urlPattern = /^(https?:\/\/)?([\da-z.-]+)\.([a-z.]{2,6})([/\w .-]*)*\/?$/;
            const errorElement = input.id === 'qr-content' ?
                document.getElementById('url-error') :
                document.getElementById('url-error-edit');

            if (!input.value.startsWith('http://') && !input.value.startsWith('https://')) {
                input.setCustomValidity('URL must start with http:// or https://');
                errorElement.classList.remove('hidden');
                return false;
            }

            if (!urlPattern.test(input.value)) {
                input.setCustomValidity('Please enter a valid URL format');
                errorElement.classList.remove('hidden');
                return false;
            }

            input.setCustomValidity('');
            errorElement.classList.add('hidden');
            return true;
        }

        // Edit QR Code
        function showEditModal(key, qrName, qrContent) {
            const editModal = document.getElementById("edit-modal");
            document.getElementById("edit-qr-name").value = qrName;
            document.getElementById("edit-qr-content").value = qrContent;
            editModal.dataset.key = key;
            editModal.classList.remove("hidden");
        }

        function closeEditModal() {
            document.getElementById("edit-modal").classList.add("hidden");
        }

        //Lưu chỉnh sửa mã QR
        async function saveQRCodeEdit() {
            const editModal = document.getElementById("edit-modal");
            const key = editModal.dataset.key;
            const newQrName = document.getElementById("edit-qr-name").value.trim();
            const newQrContent = document.getElementById("edit-qr-content").value.trim();

            if (!newQrName || !newQrContent) {
                alert("Please enter all required information!");
                return;
            }

            if (!validateURL(document.getElementById("edit-qr-content"))) {
                return;
            }

            try {
                const qrRef = ref(database, `qrCodes/${key}`);
                await update(qrRef, {
                    name: newQrName,
                    content: newQrContent,
                    updatedAt: new Date().toISOString()
                });

                alert("Mã QR được cập nhật thành công!");
                closeEditModal();
            } catch (error) {
                console.error("Error updating QR code:", error);
                alert("Đã xảy ra lỗi khi cập nhật mã QR!");
            }
        }

        // Delete QR Code
        async function deleteQRCode(key) {
            if (!confirm("Bạn có chắc chắn muốn xóa mã QR này không?")) {
                return;
            }

            try {
                await set(ref(database, `qrCodes/${key}`), null);
                alert("Đã xóa mã QR thành công!");
                await loadQRCodes(currentUser.uid);
            } catch (error) {
                console.error("Error deleting QR code:", error);
                alert("Đã xảy ra lỗi khi xóa mã QR.");
            }
        }

        // Filter QR Codes
        function filterQRCodes() {
            const searchValue = document.getElementById("search-qr").value.toLowerCase();
            const qrItems = document.querySelectorAll("#qr-list .qr-item");

            qrItems.forEach((item) => {
                const name = item.querySelector(".qr-actions p").textContent.toLowerCase();
                item.style.display = name.includes(searchValue) ? "flex" : "none";
            });
        }

        // Utility Functions
        function resetForm() {
            document.getElementById("qr-name").value = "";
            document.getElementById("qr-content").value = "";
            document.getElementById("qr-color").value = "#000000";
        }

        // Authentication Management
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const username = user.email.split('@')[0];
                document.getElementById("user-name").textContent = `Xin chào, ${username}`;
                loadQRCodes(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        // Event Listeners
        document.getElementById("logout-btn").addEventListener("click", async () => {
            try {
                await signOut(auth);
                window.location.href = "login.html";
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });

        // Lắng nghe sự kiện khi người dùng thay đổi màu sắc
        document.getElementById('qr-color').addEventListener('input', function (event) {
            // Lấy giá trị màu sắc đã chọn từ input màu
            const selectedColor = event.target.value;

            // Cập nhật màu nền của ô hiển thị màu
            document.getElementById('color-display').style.backgroundColor = selectedColor;
        });

       
        // Export functions for global access
        window.generateAndSaveQRCode = createAndSaveQRCode;
        window.validateURL = validateURL;
        window.filterQRCodes = filterQRCodes;
        window.closeEditModal = closeEditModal;
        window.saveQRCodeEdit = saveQRCodeEdit;

    </script>
</body>

</html>
