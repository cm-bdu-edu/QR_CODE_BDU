<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Trình tạo mã QR</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="./image/Logo.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        .qr-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }

        @media (min-width: 640px) {
            .qr-item {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .qr-item img {
            max-width: 100px;
            margin: 0 auto 1rem;
        }

        @media (min-width: 640px) {
            .qr-item img {
                margin: 0 1rem 0 0;
            }
        }

        .qr-item .qr-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        @media (min-width: 640px) {
            .qr-item .qr-actions {
                align-items: flex-end;
                width: auto;
            }
        }

        .qr-item button {
            margin-top: 0.5rem;
            background-color: #ff6b6b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            width: 100%;
            max-width: 200px;
        }

        @media (min-width: 640px) {
            .qr-item button {
                width: auto;
            }
        }

        .qr-item button:hover {
            background-color: #ff4c4c;
        }

        /* Responsive header */
        @media (max-width: 640px) {
            #user-info {
                margin-top: 1rem;
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Responsive modal */
        @media (max-width: 768px) {
            #edit-modal>div {
                width: 90%;
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
        }
    </style>
</head>

<body class="bg-white-400 text-gray-800">
    <header class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex flex-wrap items-center justify-between">
            <div class="flex items-center gap-x-3 w-full sm:w-auto justify-center sm:justify-start">
                <img src="./image/appLogoIcon.png" alt="Logo" class="h-10 w-auto mr-3" loading="lazy">
                <h1 class="text-xl sm:text-2xl font-bold whitespace-nowrap">Trình tạo mã QR</h1>
            </div>
            <div id="user-info"
                class="flex items-center gap-x-4 w-full sm:w-auto justify-center sm:justify-end mt-4 sm:mt-0">
                <span id="user-name" class="font-medium"></span>
                <button id="logout-btn"
                    class="bg-red-500 px-4 py-2 rounded-md hover:bg-red-600 focus:outline-none focus:ring focus:ring-red-300 w-full sm:w-auto">
                    Đăng Xuất
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto bg-white rounded-lg shadow-lg p-4 sm:p-6 mt-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Section: QR Code List -->
            <div class="order-2 lg:order-1">
                <h2 class="text-lg font-semibold mb-4">Danh sách mã QR của bạn</h2>
                <input type="text" id="search-qr" placeholder="Tìm kiếm mã QR..."
                    class="w-full p-2 mb-4 border rounded-md" oninput="filterQRCodes()">
                <div id="qr-list-container"
                    class="bg-gray-100 p-4 rounded-md shadow-md max-h-[calc(100vh-400px)] overflow-y-auto">
                    <ul id="qr-list"></ul>
                </div>
            </div>

            <!-- Right Section: QR Code Generator -->
            <div class="order-1 lg:order-2">
                <h2 class="text-lg font-semibold mb-4">Tạo Mã QR</h2>
                <div class="mb-4">
                    <label for="qr-name" class="block font-medium mb-2">Tên gợi nhớ</label>
                    <input type="text" id="qr-name" placeholder="Tên mã QR (VD: QR Sự kiện)"
                        class="w-full p-3 border rounded-md">
                </div>
                <div class="mb-4">
                    <label for="qr-content" class="block font-medium mb-2">Nội dung <i>(đường dẫn liên kết)</i></label>
                    <input type="url" id="qr-content" class="w-full p-3 border rounded-md" pattern="https?://.+"
                        placeholder="https:// hoặc http://" required oninput="validateURL(this)">
                    <small id="url-error" class="text-red-500 hidden">Vui lòng nhập đúng định dạng URL (bắt đầu bằng
                        http:// hoặc https://)</small>
                </div>

                <div class="mb-4">
                    <label for="qr-color" class="block font-medium mb-2">Chọn màu mã QR</label>
                    <input type="color" id="qr-color" value="#000000" class="w-full p-3 border rounded-md">
                </div>

                <button onclick="generateAndSaveQRCode()"
                    class="w-full sm:w-auto bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                    Tạo và Lưu
                </button>
            </div>
        </div>

        <!-- Modal for Editing QR -->
        <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white p-4 sm:p-6 rounded-md shadow-md w-full max-w-md">
                <h2 class="text-lg font-semibold mb-4">Chỉnh sửa Mã QR</h2>
                <div class="mb-4">
                    <label for="edit-qr-name" class="block font-medium mb-2">Tên gợi nhớ</label>
                    <input type="text" id="edit-qr-name" class="w-full p-3 border rounded-md">
                </div>
                <div class="mb-4">
                    <label for="edit-qr-content" class="block font-medium mb-2">Nội dung <i>(đường dẫn liên
                            kết)</i></label>
                    <input type="url" id="edit-qr-content" class="w-full p-3 border rounded-md" pattern="https?://.+"
                        placeholder="https:// hoặc http://" required oninput="validateURL(this)">
                    <small id="url-error-edit" class="text-red-500 hidden">Vui lòng nhập đúng định dạng URL (bắt đầu
                        bằng http:// hoặc https://)</small>
                </div>
                <div class="flex flex-col sm:flex-row justify-end gap-2">
                    <button onclick="saveQRCodeEdit()"
                        class="w-full sm:w-auto bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                        Lưu
                    </button>
                    <button onclick="closeEditModal()"
                        class="w-full sm:w-auto bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        Hủy
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import {
            getDatabase,
            ref,
            push,
            set,
            onValue,
            query,
            orderByChild,
            equalTo,
            update
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDnkxcPxH3Gw0l-BNro17KKX2AEV_6bsaE",
            authDomain: "qr-code-65808.firebaseapp.com",
            databaseURL: "https://qr-code-65808-default-rtdb.firebaseio.com",
            projectId: "qr-code-65808",
            storageBucket: "qr-code-65808.firebasestorage.app",
            messagingSenderId: "953231243938",
            appId: "1:953231243938:web:318fde18c08154e01df5fb",
            measurementId: "G-FMV89YRW06"
        };

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const qrList = document.getElementById("qr-list");

        let currentUser = null;
        // Khai báo biến để lưu trữ unsubscribe function
        let qrCodesListener = null;

        // Hàm thêm logo vào QR code
        async function addLogoToQRCode(qrDataUrl, logoUrl, size = 500) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const qrImage = new Image();
                const logoImage = new Image();

                canvas.width = size;
                canvas.height = size;

                qrImage.onload = () => {
                    // Vẽ QR code
                    ctx.drawImage(qrImage, 0, 0, size, size);

                    logoImage.onload = () => {
                        // Tính toán kích thước và vị trí logo
                        const logoSize = size * 0.25; // Logo chiếm 25% kích thước QR
                        const logoX = (size - logoSize) / 2;
                        const logoY = (size - logoSize) / 2;

                        // Tạo vùng tròn cho logo
                        ctx.beginPath();
                        ctx.arc(logoX + logoSize / 2, logoY + logoSize / 2, logoSize / 2, 0, 2 * Math.PI);
                        ctx.fillStyle = 'white';
                        ctx.fill();

                        // Tạo đường viền cho logo
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 2;
                        ctx.stroke();

                        // Vẽ logo trong vùng tròn
                        ctx.save();
                        ctx.clip();
                        ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);
                        ctx.restore();

                        resolve(canvas.toDataURL('image/ico'));
                    };

                    logoImage.onerror = () => {
                        console.error('Lỗi khi tải logo');
                        resolve(qrDataUrl); // Trả về QR code không có logo nếu lỗi
                    };
                    logoImage.src = logoUrl;
                };

                qrImage.onerror = () => {
                    console.error('Lỗi khi tải QR code');
                    reject(new Error('Không thể tải QR code'));
                };
                qrImage.src = qrDataUrl;
            });
        }

        // Hàm tạo và lưu QR code
        // window.generateAndSaveQRCode = async function () {
        //     const name = document.getElementById("qr-name").value.trim();
        //     const content = document.getElementById("qr-content").value.trim();

        //     if (!name || !content || !currentUser) {
        //         alert("Vui lòng nhập đủ thông tin hoặc đăng nhập lại!");
        //         return;
        //     }

        //     try {
        //         const qrRef = ref(database, "qrCodes");
        //         const newQRCodeRef = push(qrRef);
        //         const redirectURL = `${window.location.origin}/QR_CODE_BDU/redirect.html?id=${newQRCodeRef.key}`;

        //         await set(newQRCodeRef, {
        //             userId: currentUser.uid,
        //             name,
        //             content,
        //             redirectURL,
        //             createdAt: new Date().toISOString()
        //         });

        //         // Reset form
        //         document.getElementById("qr-name").value = "";
        //         document.getElementById("qr-content").value = "";

        //         alert("Tạo mã QR thành công!");
        //         loadQRCodes(currentUser.uid);
        //     } catch (error) {
        //         console.error("Lỗi khi tạo QR code:", error);
        //         alert("Có lỗi xảy ra khi tạo mã QR!");
        //     }
        // };

        window.generateAndSaveQRCode = async function () {
            const name = document.getElementById("qr-name").value.trim();
            const content = document.getElementById("qr-content").value.trim();
            const color = document.getElementById("qr-color").value; // Lấy màu được chọn

            if (!name || !content || !currentUser) {
                alert("Vui lòng nhập đủ thông tin hoặc đăng nhập lại!");
                return;
            }

            try {
                const qrRef = ref(database, "qrCodes");
                const newQRCodeRef = push(qrRef);
                const redirectURL = `${window.location.origin}/QR_CODE_BDU/redirect.html?id=${newQRCodeRef.key}`;

                await set(newQRCodeRef, {
                    userId: currentUser.uid,
                    name,
                    content,
                    redirectURL,
                    createdAt: new Date().toISOString()
                });

                const qrCanvas = document.createElement("canvas");
                const ctx = qrCanvas.getContext("2d");

                // Tạo QR code
                const qrDataUrl = await QRCode.toDataURL(content, {
                    width: 300,
                    margin: 2,
                    color: {
                        dark: color, // Sử dụng màu đã chọn
                        light: "#ffffff"
                    }
                });

                const qrImage = new Image();
                qrImage.src = qrDataUrl;

                qrImage.onload = () => {
                    qrCanvas.width = 300;
                    qrCanvas.height = 300;
                    ctx.drawImage(qrImage, 0, 0);

                    // Thêm tên "BDU"
                    ctx.font = "20px Arial";
                    ctx.fillStyle = color;
                    ctx.textAlign = "center";
                    ctx.fillText("BDU", qrCanvas.width / 2, qrCanvas.height - 20);

                    // Lưu QR code đã thêm tên
                    const qrFinalUrl = qrCanvas.toDataURL("image/png");
                    const link = document.createElement("a");
                    link.href = qrFinalUrl;
                    // link.download = `${name}.png`;
                    // link.click();
                };

                // Reset form
                document.getElementById("qr-name").value = "";
                document.getElementById("qr-content").value = "";

                alert("Tạo mã QR thành công!");
                loadQRCodes(currentUser.uid);
            } catch (error) {
                console.error("Lỗi khi tạo QR code:", error);
                alert("Có lỗi xảy ra khi tạo mã QR!");
            }
        }


        // Hàm tải xuống QR code
        async function downloadQRCode(dataURL, fileName) {
            try {
                // Lưu QR code đã thêm tên
                const logoUrl = './image/Logo.ico'; // URL của logo
                const qrWithLogo = await addLogoToQRCode(dataURL, logoUrl, 1000); // Tăng kích thước khi tải xuống

                const link = document.createElement("a");
                link.href = qrWithLogo;
                link.download = fileName;
                link.click();
            } catch (error) {
                console.error('Lỗi khi tải xuống QR code:', error);
                alert("Có lỗi xảy ra khi tải xuống mã QR!");
            }
        }

        // Hàm tải danh sách QR codes
        async function loadQRCodes(userId) {
            if (qrCodesListener) {
                qrCodesListener();
            }
            const qrList = document.getElementById("qr-list");
            const qrRef = ref(database, "qrCodes");
            const userQrQuery = query(qrRef, orderByChild("userId"), equalTo(userId));

            // Lưu hàm unsubscribe để có thể hủy đăng ký sau này
            qrCodesListener = onValue(userQrQuery, async (snapshot) => {
                qrList.innerHTML = "";
                const data = snapshot.val();

                if (data) {
                    // Chuyển đổi thành mảng và sắp xếp theo thời gian tạo
                    const qrArray = Object.entries(data).map(([key, value]) => ({ key, ...value }));
                    qrArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    for (const qr of qrArray) {
                        const qrItem = document.createElement("li");
                        qrItem.className = "qr-item";

                        const img = document.createElement("img");
                        try {
                            // Tạo QR code với logo
                            const qrDataUrl = await QRCode.toDataURL(qr.redirectURL, {
                                width: 100,
                                margin: 2,
                                color: {
                                    dark: "#000000",
                                    light: "#ffffff"
                                }
                            });

                            const qrWithLogo = await addLogoToQRCode(qrDataUrl, './image/Logo.ico', 100);
                            img.src = qrWithLogo;
                        } catch (error) {
                            console.error('Lỗi khi tạo QR code:', error);
                            img.src = await QRCode.toDataURL(qr.redirectURL, {
                                width: 100,
                                margin: 2
                            });
                        }
                        qrItem.appendChild(img);

                        const qrActions = document.createElement("div");
                        qrActions.className = "qr-actions";

                        // Thêm tên QR
                        const nameText = document.createElement("p");
                        nameText.className = "font-medium text-lg mb-2 text-left";
                        nameText.textContent = qr.name;
                        qrActions.appendChild(nameText);

                        // Thêm ngày tạo
                        const dateText = document.createElement("p");
                        dateText.className = "text-sm text-gray-500 mb-2";
                        dateText.textContent = `Tạo ngày: ${new Date(qr.createdAt).toLocaleDateString('vi-VN')}`;
                        qrActions.appendChild(dateText);

                        // Tạo container cho các nút
                        const buttonContainer = document.createElement("div");
                        buttonContainer.className = "flex space-x-2 mt-2"; // Sử dụng flex để đặt các nút ngang hàng, space-x-2 để tạo khoảng cách

                        // Nút tải xuống
                        const downloadButton = document.createElement("button");
                        downloadButton.className = "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded";
                        downloadButton.textContent = "Tải xuống";
                        downloadButton.onclick = () => downloadQRCode(img.src, `${qr.name}.png`);
                        buttonContainer.appendChild(downloadButton);

                        // Nút chỉnh sửa
                        const editButton = document.createElement("button");
                        editButton.className = "bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded";
                        editButton.textContent = "Chỉnh sửa";
                        editButton.onclick = () => showEditModal(qr.key, qr.name, qr.content);
                        buttonContainer.appendChild(editButton);

                        // Nút xóa
                        const deleteButton = document.createElement("button");
                        deleteButton.className = "bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded";
                        deleteButton.textContent = "Xóa";
                        deleteButton.onclick = () => deleteQRCode(qr.key);
                        buttonContainer.appendChild(deleteButton);

                        // Thêm container vào qrActions
                        qrActions.appendChild(buttonContainer);

                        qrItem.appendChild(qrActions);
                        qrList.appendChild(qrItem);
                    }
                } else {
                    qrList.innerHTML = "<p class='text-center text-gray-500'>Bạn chưa tạo mã QR nào.</p>";
                }
            });
        }

        // Hàm kiểm tra URL
        window.validateURL = function (input) {
            const urlPattern = /^(https?:\/\/)?([\da-z.-]+)\.([a-z.]{2,6})([/\w .-]*)*\/?$/;
            const errorElement = input.id === 'qr-content' ?
                document.getElementById('url-error') :
                document.getElementById('url-error-edit');

            if (!input.value.startsWith('http://') && !input.value.startsWith('https://')) {
                input.setCustomValidity('URL phải bắt đầu bằng http:// hoặc https://');
                errorElement.classList.remove('hidden');
                return false;
            }

            if (!urlPattern.test(input.value)) {
                input.setCustomValidity('Vui lòng nhập đúng định dạng URL');
                errorElement.classList.remove('hidden');
                return false;
            }

            input.setCustomValidity('');
            errorElement.classList.add('hidden');
            return true;
        };

        // Hàm lọc QR codes
        window.filterQRCodes = function () {
            const searchValue = document.getElementById("search-qr").value.toLowerCase();
            const qrItems = document.querySelectorAll("#qr-list .qr-item");

            qrItems.forEach((item) => {
                const name = item.querySelector(".qr-actions p").textContent.toLowerCase();
                if (name.includes(searchValue)) {
                    item.style.display = "flex";
                } else {
                    item.style.display = "none";
                }
            });
        };

        // Hàm hiển thị modal chỉnh sửa
        function showEditModal(key, qrName, qrContent) {
            const editModal = document.getElementById("edit-modal");
            const editQrNameInput = document.getElementById("edit-qr-name");
            const editQrContentInput = document.getElementById("edit-qr-content");

            editQrNameInput.value = qrName;
            editQrContentInput.value = qrContent;
            editModal.dataset.key = key;
            editModal.classList.remove("hidden");
        }

        // Hàm đóng modal
        window.closeEditModal = function () {
            document.getElementById("edit-modal").classList.add("hidden");
        };

        // Hàm lưu chỉnh sửa QR code
        window.saveQRCodeEdit = async function () {
            const editModal = document.getElementById("edit-modal");
            const key = editModal.dataset.key;
            const newQrName = document.getElementById("edit-qr-name").value.trim();
            const newQrContent = document.getElementById("edit-qr-content").value.trim();

            if (!newQrName || !newQrContent) {
                alert("Vui lòng nhập đủ thông tin!");
                return;
            }

            if (!validateURL(document.getElementById("edit-qr-content"))) {
                alert("Vui lòng nhập đúng định dạng URL!");
                return;
            }

            try {
                const qrRef = ref(database, `qrCodes/${key}`);
                await update(qrRef, {
                    name: newQrName,
                    content: newQrContent,
                    updatedAt: new Date().toISOString()
                });

                alert("Chỉnh sửa thành công!");
                closeEditModal();
            } catch (error) {
                console.error("Lỗi khi cập nhật:", error);
                alert("Có lỗi xảy ra khi cập nhật!");
            }
        };

        // Hàm xóa QR code
        function deleteQRCode(key) {
            const confirmDelete = confirm("Bạn có chắc chắn muốn xóa mã QR này?");
            if (confirmDelete) {
                const qrRef = ref(database, `qrCodes/${key}`);
                set(qrRef, null) // Xóa dữ liệu tại khóa này
                    .then(() => {
                        alert("Xóa mã QR thành công!");
                        loadQRCodes(currentUser.uid); // Tải lại danh sách sau khi xóa
                    })
                    .catch((error) => {
                        console.error("Xóa mã QR thất bại:", error);
                        alert("Đã xảy ra lỗi khi xóa mã QR.");
                    });
            }
        }

        // Xử lý đăng nhập và hiển thị thông tin người dùng
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const username = user.email.split('@')[0];
                document.getElementById("user-name").textContent = `Xin chào, ${username}`;
                loadQRCodes(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        // Xử lý đăng xuất
        const logoutButton = document.getElementById("logout-btn");
        logoutButton.addEventListener("click", async () => {
            try {
                await signOut(auth);
                window.location.href = "login.html";
            } catch (error) {
                console.error("Đăng xuất thất bại:", error);
            }
        });

    </script>
</body>

</html>