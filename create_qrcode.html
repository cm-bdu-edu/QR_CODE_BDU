<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình tạo mã QR</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="./image/Logo.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        .qr-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }

        .qr-item img {
            max-width: 100px;
            margin-right: 1rem;
        }

        .qr-item .qr-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .qr-item button {
            margin-top: 0.5rem;
            background-color: #ff6b6b;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }

        .qr-item button:hover {
            background-color: #ff4c4c;
        }
    </style>
</head>

<body class="bg-white-400 text-gray-800">
    <header class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex items-center justify-between">
            <h1 class="text-2xl font-bold flex items-center">
                <span class="text-white text-3xl font-bold mr-2"></span> Trình tạo mã QR
            </h1>
            <div id="user-info" class="flex items-center space-x-4">
                <span id="user-name" class="text-white font-medium"></span>
                <button id="logout-btn" class="bg-red-500 px-4 py-2 rounded-md hover:bg-red-600">
                    Đăng Xuất
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto bg-white rounded-lg shadow-lg p-6 mt-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Section: QR Code Generator -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Tạo Mã QR</h2>
                <div class="mb-4">
                    <label for="qr-name" class="block font-medium mb-2">Tên mã QR</label>
                    <input type="text" id="qr-name" placeholder="Tên mã QR (VD: QR Sự kiện)"
                        class="w-full p-3 border rounded-md">
                </div>
                <div class="mb-4">
                    <label for="qr-content" class="block font-medium mb-2">Nội dung</label>
                    <input type="text" id="qr-content" placeholder="https://www.bdu.edu.vn/"
                        class="w-full p-3 border rounded-md">
                </div>
                <button onclick="generateAndSaveQRCode()"
                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                    Tạo và Lưu QR Code
                </button>
            </div>

            <!-- Right Section: QR Code List -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Danh sách mã QR của bạn</h2>
                <ul id="qr-list" class="bg-gray-100 p-4 rounded-md shadow-md"></ul>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import {
            getDatabase,
            ref,
            push,
            set,
            onValue,
            query,
            orderByChild,
            equalTo,
            update
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDnkxcPxH3Gw0l-BNro17KKX2AEV_6bsaE",
            authDomain: "qr-code-65808.firebaseapp.com",
            databaseURL: "https://qr-code-65808-default-rtdb.firebaseio.com",
            projectId: "qr-code-65808",
            storageBucket: "qr-code-65808.firebasestorage.app",
            messagingSenderId: "953231243938",
            appId: "1:953231243938:web:318fde18c08154e01df5fb",
            measurementId: "G-FMV89YRW06"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const qrList = document.getElementById("qr-list");

        let currentUser = null;

        // Monitor auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadQRCodes(user.uid);
            } else {
                currentUser = null;
                alert("Bạn chắc chắn đăng xuất khỏi trang này!");
                window.location.href = "login.html";
            }
        });

        // Generate and save QR Code
        window.generateAndSaveQRCode = async function () {
            const name = document.getElementById("qr-name").value.trim();
            const content = document.getElementById("qr-content").value.trim();

            if (!name || !content || !currentUser) {
                alert("Vui lòng nhập đủ thông tin hoặc đăng nhập lại!");
                return;
            }

            const qrRef = ref(database, "qrCodes");
            const newQRCodeRef = push(qrRef);

            const redirectURL = `${window.location.origin}/QR_CODE_BDU/redirect.html?id=${newQRCodeRef.key}`;

            await set(newQRCodeRef, {
                userId: currentUser.uid,
                name,
                content,
                redirectURL
            });

            loadQRCodes(currentUser.uid);
        };

        // Load QR Codes
        function loadQRCodes(userId) {
            const qrRef = ref(database, "qrCodes");
            const userQrQuery = query(qrRef, orderByChild("userId"), equalTo(userId));

            onValue(userQrQuery, (snapshot) => {
                qrList.innerHTML = "";
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).forEach(([key, qr]) => {
                        const qrItem = document.createElement("li");
                        qrItem.className = "qr-item";

                        const img = document.createElement("img");
                        QRCode.toDataURL(qr.redirectURL, { width: 100, margin: 2 }).then((url) => {
                            img.src = url;
                        });
                        qrItem.appendChild(img);

                        const qrActions = document.createElement("div");
                        qrActions.className = "qr-actions";

                        const nameText = document.createElement("p");
                        nameText.textContent = qr.name;
                        qrActions.appendChild(nameText);

                        const downloadButton = document.createElement("button");
                        downloadButton.textContent = "Tải mã QR";
                        downloadButton.onclick = () => downloadQRCode(img.src, `${qr.name}.png`);
                        qrActions.appendChild(downloadButton);

                        const editButton = document.createElement("button");
                        editButton.textContent = "Chỉnh sửa";
                        editButton.onclick = () => editQRCode(key, qr.name, qr.content);
                        qrActions.appendChild(editButton);

                        qrItem.appendChild(qrActions);
                        qrList.appendChild(qrItem);

                        // Thêm nút Xóa
                        const deleteButton = document.createElement("button");
                        deleteButton.textContent = "Xóa";
                        deleteButton.onclick = () => deleteQRCode(key);
                        qrActions.appendChild(deleteButton);

                        qrItem.appendChild(qrActions);
                        qrList.appendChild(qrItem);
                    });
                } else {
                    qrList.textContent = "Bạn chưa tạo mã QR nào.";
                }
            });
        }

        // Download QR Code
        function downloadQRCode(dataURL, fileName) {
            const link = document.createElement("a");
            link.href = dataURL;
            link.download = fileName;
            link.click();
        }

        // Edit QR Code
        function editQRCode(key, currentName, currentContent) {
            const newName = prompt("Nhập tên mới cho mã QR:", currentName);
            const newContent = prompt("Nhập nội dung mới cho mã QR:", currentContent);

            if (newName !== null && newContent !== null) {
                const qrRef = ref(database, `qrCodes/${key}`);
                update(qrRef, { name: newName, content: newContent });
                loadQRCodes(currentUser.uid); // reload to show the updated list
            }
        }

        // Xóa QR Code
        function deleteQRCode(key) {
            const confirmDelete = confirm("Bạn có chắc chắn muốn xóa mã QR này?");
            if (confirmDelete) {
                const qrRef = ref(database, `qrCodes/${key}`);
                set(qrRef, null) // Xóa dữ liệu tại khóa này
                    .then(() => {
                        alert("Xóa mã QR thành công!");
                        loadQRCodes(currentUser.uid); // Tải lại danh sách sau khi xóa
                    })
                    .catch((error) => {
                        console.error("Xóa mã QR thất bại:", error);
                        alert("Đã xảy ra lỗi khi xóa mã QR.");
                    });
            }
        }

        // User info and logout
        const userNameElement = document.getElementById("user-name");
        const logoutButton = document.getElementById("logout-btn");

        // Monitor user state for logout
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userNameElement.textContent = `Xin chào, ${user.email}`;
            } else {
                window.location.href = "login.html";
            }
        });

        // Handle logout
        logoutButton.addEventListener("click", async () => {
            try {
                await signOut(auth);
                window.location.href = "login.html";
            } catch (error) {
                console.error("Đăng xuất thất bại:", error);
            }
        });

    </script>
</body>

</html>